<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>softusbduino: SoftUsb/usbdrvasm15.inc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">softusbduino</div>
  </td>
  <td>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">SoftUsb/usbdrvasm15.inc</div>  </div>
</div>
<div class="contents">
<a href="usbdrvasm15_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Name: usbdrvasm15.inc</span>
<a name="l00002"></a>00002 <span class="comment"> * Project: V-USB, virtual USB port for Atmel&#39;s(r) AVR(r) microcontrollers</span>
<a name="l00003"></a>00003 <span class="comment"> * Author: contributed by V. Bosch</span>
<a name="l00004"></a>00004 <span class="comment"> * Creation Date: 2007-08-06</span>
<a name="l00005"></a>00005 <span class="comment"> * Tabsize: 4</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright: (c) 2007 by OBJECTIVE DEVELOPMENT Software GmbH</span>
<a name="l00007"></a>00007 <span class="comment"> * License: GNU GPL v2 (see License.txt), GNU GPL v3 or proprietary (CommercialLicense.txt)</span>
<a name="l00008"></a>00008 <span class="comment"> * Revision: $Id: usbdrvasm15.inc 740 2009-04-13 18:23:31Z cs $</span>
<a name="l00009"></a>00009 <span class="comment"> */</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">/* Do not link this file! Link usbdrvasm.S instead, which includes the</span>
<a name="l00012"></a>00012 <span class="comment"> * appropriate implementation!</span>
<a name="l00013"></a>00013 <span class="comment"> */</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">/*</span>
<a name="l00016"></a>00016 <span class="comment">General Description:</span>
<a name="l00017"></a>00017 <span class="comment">This file is the 15 MHz version of the asssembler part of the USB driver. It</span>
<a name="l00018"></a>00018 <span class="comment">requires a 15 MHz crystal (not a ceramic resonator and not a calibrated RC</span>
<a name="l00019"></a>00019 <span class="comment">oscillator).</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">See usbdrv.h for a description of the entire driver.</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">Since almost all of this code is timing critical, don&#39;t change unless you</span>
<a name="l00024"></a>00024 <span class="comment">really know what you are doing! Many parts require not only a maximum number</span>
<a name="l00025"></a>00025 <span class="comment">of CPU cycles, but even an exact number of cycles!</span>
<a name="l00026"></a>00026 <span class="comment">*/</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 ;max stack usage: [ret(2), YL, SREG, YH, bitcnt, shift, x1, x2, x3, x4, cnt] = 12 bytes
<a name="l00029"></a>00029 ;nominal frequency: 15 MHz -&gt; 10.0 cycles per bit, 80.0 cycles per byte
<a name="l00030"></a>00030 ; Numbers in brackets are clocks counted from center of last sync bit
<a name="l00031"></a>00031 ; when instruction starts
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 ;----------------------------------------------------------------------------
<a name="l00034"></a>00034 ; order of registers pushed: 
<a name="l00035"></a>00035 ;   YL, SREG [sofError] YH, shift, x1, x2, x3, bitcnt, cnt, x4
<a name="l00036"></a>00036 ;----------------------------------------------------------------------------
<a name="l00037"></a>00037 USB_INTR_VECTOR:              
<a name="l00038"></a>00038     push    YL                   ;2     push only what is necessary to sync with edge ASAP
<a name="l00039"></a>00039     in      YL, SREG             ;1 
<a name="l00040"></a>00040     push    YL                   ;2 
<a name="l00041"></a>00041 ;----------------------------------------------------------------------------
<a name="l00042"></a>00042 ; Synchronize with sync pattern:
<a name="l00043"></a>00043 ;
<a name="l00044"></a>00044 ;   sync byte (D-) pattern LSb to MSb: 01010100 [1 = idle = J, 0 = K]
<a name="l00045"></a>00045 ;   sync up with J to K edge during sync pattern -- use fastest possible loops
<a name="l00046"></a>00046 ;The first part waits at most 1 bit <span class="keywordtype">long</span> since we must be in sync pattern.
<a name="l00047"></a>00047 ;YL is guarenteed to be &lt; 0x80 because I flag is clear. When we jump to
<a name="l00048"></a>00048 ;waitForJ, ensure that this prerequisite is met.
<a name="l00049"></a>00049 waitForJ:
<a name="l00050"></a>00050     inc     YL
<a name="l00051"></a>00051     sbis    <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>
<a name="l00052"></a>00052     brne    waitForJ        ; just make sure we have ANY timeout
<a name="l00053"></a>00053 ;-------------------------------------------------------------------------------
<a name="l00054"></a>00054 ; The following code results in a sampling window of &lt; 1/4 bit 
<a name="l00055"></a>00055 ;   which meets the spec.
<a name="l00056"></a>00056 ;-------------------------------------------------------------------------------
<a name="l00057"></a>00057 waitForK:            ;- 
<a name="l00058"></a>00058     sbis    USBIN, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>      ;1 [00] &lt;-- sample
<a name="l00059"></a>00059     rjmp    foundK               ;2 [01]
<a name="l00060"></a>00060     sbis    USBIN, USBMINUS  ;   &lt;-- sample
<a name="l00061"></a>00061     rjmp    foundK
<a name="l00062"></a>00062     sbis    USBIN, USBMINUS  ;   &lt;-- sample
<a name="l00063"></a>00063     rjmp    foundK
<a name="l00064"></a>00064     sbis    USBIN, USBMINUS  ;   &lt;-- sample
<a name="l00065"></a>00065     rjmp    foundK
<a name="l00066"></a>00066     sbis    USBIN, USBMINUS  ;   &lt;-- sample
<a name="l00067"></a>00067     rjmp    foundK
<a name="l00068"></a>00068     sbis    USBIN, USBMINUS  ;   &lt;-- sample
<a name="l00069"></a>00069     rjmp    foundK
<a name="l00070"></a>00070 <span class="preprocessor">#if USB_COUNT_SOF</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>    lds     YL, usbSofCount
<a name="l00072"></a>00072     inc     YL
<a name="l00073"></a>00073     sts     usbSofCount, YL
<a name="l00074"></a>00074 <span class="preprocessor">#endif  </span><span class="comment">/* USB_COUNT_SOF */</span>
<a name="l00075"></a>00075 <span class="preprocessor">#ifdef USB_SOF_HOOK</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>    USB_SOF_HOOK
<a name="l00077"></a>00077 <span class="preprocessor">#endif</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>    rjmp    sofError
<a name="l00079"></a>00079 ;------------------------------------------------------------------------------
<a name="l00080"></a>00080 ; {3, 5} after falling D- edge, average delay: 4 cycles [we want 5 for 
<a name="l00081"></a>00081 ;   center sampling] 
<a name="l00082"></a>00082 ;   we have 1 bit time <span class="keywordflow">for</span> setup purposes, then sample again. 
<a name="l00083"></a>00083 ;   Numbers in brackets are cycles from center of first sync (<span class="keywordtype">double</span> K) 
<a name="l00084"></a>00084 ;   bit after the instruction
<a name="l00085"></a>00085 ;------------------------------------------------------------------------------
<a name="l00086"></a>00086 foundK:                          ;- [02]
<a name="l00087"></a>00087     lds     YL, <a class="code" href="usbdrv_8c.html#a6b0f7b83997deee705eb56462e3f1fce">usbInputBufOffset</a>;2 [03+04] tx loop
<a name="l00088"></a>00088     push    YH                   ;2 [05+06]
<a name="l00089"></a>00089     clr     YH                   ;1 [07]
<a name="l00090"></a>00090     subi    YL, lo8(-(<a class="code" href="usbdrv_8c.html#a50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>)) ;1 [08]    [rx loop init]
<a name="l00091"></a>00091     sbci    YH, hi8(-(<a class="code" href="usbdrv_8c.html#a50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>)) ;1 [09]    [rx loop init]
<a name="l00092"></a>00092     push    shift                ;2 [10+11]
<a name="l00093"></a>00093     ser     shift        ;1 [12]
<a name="l00094"></a>00094     sbis    <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>      ;1 [-1] [13] &lt;--sample:we want two bits K (sample 1 cycle too early)
<a name="l00095"></a>00095     rjmp    haveTwoBitsK         ;2 [00] [14]
<a name="l00096"></a>00096     pop     shift                ;2      [15+16] undo the push from before
<a name="l00097"></a>00097     pop     YH           ;2      [17+18] undo the push from before
<a name="l00098"></a>00098     rjmp    waitForK             ;2      [19+20] <span class="keyword">this</span> was not the end of sync, retry
<a name="l00099"></a>00099 ; The entire loop from waitForK until rjmp waitForK above must not exceed two
<a name="l00100"></a>00100 ; bit times (= 20 cycles).
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 ;----------------------------------------------------------------------------
<a name="l00103"></a>00103 ; push more registers and initialize values <span class="keywordflow">while</span> we sample the first bits:
<a name="l00104"></a>00104 ;----------------------------------------------------------------------------
<a name="l00105"></a>00105 haveTwoBitsK:           ;- [01]
<a name="l00106"></a>00106     push    x1                  ;2 [02+03]
<a name="l00107"></a>00107     push    x2                  ;2 [04+05]
<a name="l00108"></a>00108     push    x3                  ;2 [06+07]
<a name="l00109"></a>00109     push    bitcnt              ;2 [08+09]  
<a name="l00110"></a>00110     in      x1, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>           ;1 [00] [10] &lt;-- sample bit 0
<a name="l00111"></a>00111     bst     x1, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>        ;1 [01]
<a name="l00112"></a>00112     bld     shift, 0            ;1 [02]
<a name="l00113"></a>00113     push    cnt                 ;2 [03+04]
<a name="l00114"></a>00114     ldi     cnt, <a class="code" href="usbdrv_8h.html#a1c541dbab181ea7bd3da61b892430988">USB_BUFSIZE</a>    ;1 [05] 
<a name="l00115"></a>00115     push    x4                  ;2 [06+07] tx loop
<a name="l00116"></a>00116     rjmp    rxLoop              ;2 [08]
<a name="l00117"></a>00117 ;----------------------------------------------------------------------------
<a name="l00118"></a>00118 ; Receiver loop (numbers in brackets are cycles within byte after instr)
<a name="l00119"></a>00119 ;----------------------------------------------------------------------------
<a name="l00120"></a>00120 unstuff0:                   ;- [07] (branch taken)
<a name="l00121"></a>00121     andi    x3, ~0x01       ;1 [08]
<a name="l00122"></a>00122     mov     x1, x2          ;1 [09] x2 contains last sampled (stuffed) bit
<a name="l00123"></a>00123     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 1 again
<a name="l00124"></a>00124     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;1 [01]
<a name="l00125"></a>00125     breq    se0Hop          ;1 [02] SE0 check for bit 1 
<a name="l00126"></a>00126     ori     shift, 0x01     ;1 [03] 0b00000001
<a name="l00127"></a>00127     nop             ;1 [04]
<a name="l00128"></a>00128     rjmp    didUnstuff0     ;2 [05]
<a name="l00129"></a>00129 ;-----------------------------------------------------
<a name="l00130"></a>00130 unstuff1:                   ;- [05] (branch taken)
<a name="l00131"></a>00131     mov     x2, x1          ;1 [06] x1 contains last sampled (stuffed) bit
<a name="l00132"></a>00132     andi    x3, ~0x02       ;1 [07]
<a name="l00133"></a>00133     ori     shift, 0x02     ;1 [08] 0b00000010
<a name="l00134"></a>00134     nop                     ;1 [09]
<a name="l00135"></a>00135     in      x1, USBIN       ;1 [00] [10] &lt;-- sample bit 2 again
<a name="l00136"></a>00136     andi    x1, USBMASK     ;1 [01]
<a name="l00137"></a>00137     breq    se0Hop          ;1 [02] SE0 check for bit 2 
<a name="l00138"></a>00138     rjmp    didUnstuff1     ;2 [03]
<a name="l00139"></a>00139 ;-----------------------------------------------------
<a name="l00140"></a>00140 unstuff2:                   ;- [05] (branch taken)
<a name="l00141"></a>00141     andi    x3, ~0x04       ;1 [06]
<a name="l00142"></a>00142     ori     shift, 0x04     ;1 [07] 0b00000100
<a name="l00143"></a>00143     mov     x1, x2          ;1 [08] x2 contains last sampled (stuffed) bit
<a name="l00144"></a>00144     nop                     ;1 [09]
<a name="l00145"></a>00145     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 3
<a name="l00146"></a>00146     andi    x2, USBMASK     ;1 [01]
<a name="l00147"></a>00147     breq    se0Hop          ;1 [02] SE0 check for bit 3 
<a name="l00148"></a>00148     rjmp    didUnstuff2     ;2 [03]
<a name="l00149"></a>00149 ;-----------------------------------------------------
<a name="l00150"></a>00150 unstuff3:                   ;- [00] [10]  (branch taken)
<a name="l00151"></a>00151     in      x2, USBIN       ;1 [01] [11] &lt;-- sample stuffed bit 3 one cycle too late
<a name="l00152"></a>00152     andi    x2, USBMASK     ;1 [02]
<a name="l00153"></a>00153     breq    se0Hop          ;1 [03] SE0 check for stuffed bit 3 
<a name="l00154"></a>00154     andi    x3, ~0x08       ;1 [04]
<a name="l00155"></a>00155     ori     shift, 0x08     ;1 [05] 0b00001000
<a name="l00156"></a>00156     rjmp    didUnstuff3     ;2 [06]
<a name="l00157"></a>00157 ;----------------------------------------------------------------------------
<a name="l00158"></a>00158 ; extra jobs done during bit interval:
<a name="l00159"></a>00159 ;
<a name="l00160"></a>00160 ; bit 0:    store, clear [SE0 is unreliable here due to bit dribbling in hubs], 
<a name="l00161"></a>00161 ;       overflow check, jump to the head of rxLoop
<a name="l00162"></a>00162 ; bit 1:    SE0 check
<a name="l00163"></a>00163 ; bit 2:    SE0 check, recovery from delay [bit 0 tasks took too <span class="keywordtype">long</span>]
<a name="l00164"></a>00164 ; bit 3:    SE0 check, recovery from delay [bit 0 tasks took too <span class="keywordtype">long</span>]
<a name="l00165"></a>00165 ; bit 4:    SE0 check, none
<a name="l00166"></a>00166 ; bit 5:    SE0 check, none
<a name="l00167"></a>00167 ; bit 6:    SE0 check, none
<a name="l00168"></a>00168 ; bit 7:    SE0 check, reconstruct: x3 is 0 at bit locations we changed, 1 at others
<a name="l00169"></a>00169 ;----------------------------------------------------------------------------
<a name="l00170"></a>00170 rxLoop:             ;- [09]
<a name="l00171"></a>00171     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 1 (or possibly bit 0 stuffed)
<a name="l00172"></a>00172     andi    x2, USBMASK     ;1 [01]
<a name="l00173"></a>00173     brne    SkipSe0Hop      ;1 [02]
<a name="l00174"></a>00174 se0Hop:             ;- [02]
<a name="l00175"></a>00175     rjmp    se0             ;2 [03] SE0 check for bit 1 
<a name="l00176"></a>00176 SkipSe0Hop:         ;- [03]
<a name="l00177"></a>00177     ser     x3              ;1 [04]
<a name="l00178"></a>00178     andi    shift, 0xf9     ;1 [05] 0b11111001
<a name="l00179"></a>00179     breq    unstuff0        ;1 [06]
<a name="l00180"></a>00180 didUnstuff0:            ;- [06]
<a name="l00181"></a>00181     eor     x1, x2          ;1 [07]
<a name="l00182"></a>00182     bst     x1, USBMINUS    ;1 [08]
<a name="l00183"></a>00183     bld     shift, 1        ;1 [09] 
<a name="l00184"></a>00184     in      x1, USBIN       ;1 [00] [10] &lt;-- sample bit 2 (or possibly bit 1 stuffed)
<a name="l00185"></a>00185     andi    x1, USBMASK     ;1 [01]
<a name="l00186"></a>00186     breq    se0Hop          ;1 [02] SE0 check for bit 2 
<a name="l00187"></a>00187     andi    shift, 0xf3     ;1 [03] 0b11110011
<a name="l00188"></a>00188     breq    unstuff1        ;1 [04] do remaining work for bit 1
<a name="l00189"></a>00189 didUnstuff1:            ;- [04]
<a name="l00190"></a>00190     eor     x2, x1          ;1 [05]
<a name="l00191"></a>00191     bst     x2, USBMINUS    ;1 [06]
<a name="l00192"></a>00192     bld     shift, 2        ;1 [07]
<a name="l00193"></a>00193     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>            ;2 [08+09]
<a name="l00194"></a>00194     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 3 (or possibly bit 2 stuffed)
<a name="l00195"></a>00195     andi    x2, USBMASK     ;1 [01]
<a name="l00196"></a>00196     breq    se0Hop          ;1 [02] SE0 check for bit 3 
<a name="l00197"></a>00197     andi    shift, 0xe7     ;1 [03] 0b11100111
<a name="l00198"></a>00198     breq    unstuff2        ;1 [04]
<a name="l00199"></a>00199 didUnstuff2:            ;- [04]
<a name="l00200"></a>00200     eor     x1, x2          ;1 [05]
<a name="l00201"></a>00201     bst     x1, USBMINUS    ;1 [06]
<a name="l00202"></a>00202     bld     shift, 3        ;1 [07]
<a name="l00203"></a>00203 didUnstuff3:            ;- [07]
<a name="l00204"></a>00204     andi    shift, 0xcf     ;1 [08] 0b11001111
<a name="l00205"></a>00205     breq    unstuff3        ;1 [09]
<a name="l00206"></a>00206     in      x1, USBIN       ;1 [00] [10] &lt;-- sample bit 4
<a name="l00207"></a>00207     andi    x1, USBMASK     ;1 [01]
<a name="l00208"></a>00208     breq    se0Hop          ;1 [02] SE0 check for bit 4
<a name="l00209"></a>00209     eor     x2, x1          ;1 [03]
<a name="l00210"></a>00210     bst     x2, USBMINUS    ;1 [04]
<a name="l00211"></a>00211     bld     shift, 4        ;1 [05]
<a name="l00212"></a>00212 didUnstuff4:            ;- [05]
<a name="l00213"></a>00213     andi    shift, 0x9f     ;1 [06] 0b10011111
<a name="l00214"></a>00214     breq    unstuff4        ;1 [07]
<a name="l00215"></a>00215     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>            ;2 [08+09]
<a name="l00216"></a>00216     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 5
<a name="l00217"></a>00217     andi    x2, USBMASK     ;1 [01]
<a name="l00218"></a>00218     breq    se0             ;1 [02] SE0 check for bit 5
<a name="l00219"></a>00219     eor     x1, x2          ;1 [03]
<a name="l00220"></a>00220     bst     x1, USBMINUS    ;1 [04]
<a name="l00221"></a>00221     bld     shift, 5        ;1 [05]
<a name="l00222"></a>00222 didUnstuff5:            ;- [05]
<a name="l00223"></a>00223     andi    shift, 0x3f     ;1 [06] 0b00111111
<a name="l00224"></a>00224     breq    unstuff5        ;1 [07]
<a name="l00225"></a>00225     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>            ;2 [08+09]
<a name="l00226"></a>00226     in      x1, USBIN       ;1 [00] [10] &lt;-- sample bit 6
<a name="l00227"></a>00227     andi    x1, USBMASK     ;1 [01]
<a name="l00228"></a>00228     breq    se0             ;1 [02] SE0 check for bit 6
<a name="l00229"></a>00229     eor     x2, x1          ;1 [03]
<a name="l00230"></a>00230     bst     x2, USBMINUS    ;1 [04]
<a name="l00231"></a>00231     bld     shift, 6        ;1 [05]
<a name="l00232"></a>00232 didUnstuff6:            ;- [05]
<a name="l00233"></a>00233     cpi     shift, 0x02     ;1 [06] 0b00000010
<a name="l00234"></a>00234     brlo    unstuff6        ;1 [07]
<a name="l00235"></a>00235     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>            ;2 [08+09]
<a name="l00236"></a>00236     in      x2, USBIN       ;1 [00] [10] &lt;-- sample bit 7
<a name="l00237"></a>00237     andi    x2, USBMASK     ;1 [01]
<a name="l00238"></a>00238     breq    se0             ;1 [02] SE0 check for bit 7
<a name="l00239"></a>00239     eor     x1, x2          ;1 [03]
<a name="l00240"></a>00240     bst     x1, USBMINUS    ;1 [04]
<a name="l00241"></a>00241     bld     shift, 7        ;1 [05]
<a name="l00242"></a>00242 didUnstuff7:            ;- [05] 
<a name="l00243"></a>00243     cpi     shift, 0x04     ;1 [06] 0b00000100
<a name="l00244"></a>00244     brlo    unstuff7        ;1 [07]
<a name="l00245"></a>00245     eor     x3, shift       ;1 [08] reconstruct: x3 is 0 at bit locations we changed, 1 at others
<a name="l00246"></a>00246     nop             ;1 [09]
<a name="l00247"></a>00247     in      x1, USBIN       ;1 [00] [10] &lt;-- sample bit 0
<a name="l00248"></a>00248     st      y+, x3          ;2 [01+02] store data
<a name="l00249"></a>00249     eor     x2, x1          ;1 [03]
<a name="l00250"></a>00250     bst     x2, USBMINUS    ;1 [04]
<a name="l00251"></a>00251     bld     shift, 0        ;1 [05]
<a name="l00252"></a>00252     subi    cnt, 1      ;1 [06]
<a name="l00253"></a>00253     brcs    overflow    ;1 [07]
<a name="l00254"></a>00254     rjmp    rxLoop      ;2 [08]
<a name="l00255"></a>00255 ;-----------------------------------------------------
<a name="l00256"></a>00256 unstuff4:                   ;- [08] 
<a name="l00257"></a>00257     andi    x3, ~0x10       ;1 [09]
<a name="l00258"></a>00258     in      x1, USBIN       ;1 [00] [10] &lt;-- sample stuffed bit 4
<a name="l00259"></a>00259     andi    x1, USBMASK     ;1 [01]
<a name="l00260"></a>00260     breq    se0             ;1 [02] SE0 check for stuffed bit 4
<a name="l00261"></a>00261     ori     shift, 0x10     ;1 [03]
<a name="l00262"></a>00262     rjmp    didUnstuff4     ;2 [04]
<a name="l00263"></a>00263 ;-----------------------------------------------------
<a name="l00264"></a>00264 unstuff5:                   ;- [08] 
<a name="l00265"></a>00265     ori     shift, 0x20     ;1 [09]
<a name="l00266"></a>00266     in      x2, USBIN       ;1 [00] [10] &lt;-- sample stuffed bit 5
<a name="l00267"></a>00267     andi    x2, USBMASK     ;1 [01]
<a name="l00268"></a>00268     breq    se0             ;1 [02] SE0 check for stuffed bit 5
<a name="l00269"></a>00269     andi    x3, ~0x20       ;1 [03]
<a name="l00270"></a>00270     rjmp    didUnstuff5     ;2 [04]
<a name="l00271"></a>00271 ;-----------------------------------------------------
<a name="l00272"></a>00272 unstuff6:                   ;- [08] 
<a name="l00273"></a>00273     andi    x3, ~0x40       ;1 [09]
<a name="l00274"></a>00274     in      x1, USBIN       ;1 [00] [10] &lt;-- sample stuffed bit 6
<a name="l00275"></a>00275     andi    x1, USBMASK     ;1 [01]
<a name="l00276"></a>00276     breq    se0             ;1 [02] SE0 check for stuffed bit 6
<a name="l00277"></a>00277     ori     shift, 0x40     ;1 [03]
<a name="l00278"></a>00278     rjmp    didUnstuff6     ;2 [04]
<a name="l00279"></a>00279 ;-----------------------------------------------------
<a name="l00280"></a>00280 unstuff7:           ;- [08]
<a name="l00281"></a>00281     andi    x3, ~0x80       ;1 [09]
<a name="l00282"></a>00282     in      x2, USBIN       ;1 [00] [10] &lt;-- sample stuffed bit 7
<a name="l00283"></a>00283     andi    x2, USBMASK     ;1 [01]
<a name="l00284"></a>00284     breq    se0             ;1 [02] SE0 check for stuffed bit 7
<a name="l00285"></a>00285     ori     shift, 0x80     ;1 [03]
<a name="l00286"></a>00286     rjmp    didUnstuff7     ;2 [04]
<a name="l00287"></a>00287     
<a name="l00288"></a>00288 <a class="code" href="usbportability_8h.html#a27188a3f4bdad4750865cc4b0d001559">macro</a> POP_STANDARD ; 16 cycles
<a name="l00289"></a>00289     pop     x4    
<a name="l00290"></a>00290     pop     cnt
<a name="l00291"></a>00291     pop     bitcnt
<a name="l00292"></a>00292     pop     x3
<a name="l00293"></a>00293     pop     x2
<a name="l00294"></a>00294     pop     x1
<a name="l00295"></a>00295     pop     shift
<a name="l00296"></a>00296     pop     YH
<a name="l00297"></a>00297     <a class="code" href="usbportability_8h.html#a42431a55be9ecfc03292cc1601e5c4d9">endm</a>
<a name="l00298"></a>00298 <a class="code" href="usbportability_8h.html#a27188a3f4bdad4750865cc4b0d001559">macro</a> POP_RETI     ; 5 cycles
<a name="l00299"></a>00299     pop     YL
<a name="l00300"></a>00300     out     SREG, YL
<a name="l00301"></a>00301     pop     YL
<a name="l00302"></a>00302     <a class="code" href="usbportability_8h.html#a42431a55be9ecfc03292cc1601e5c4d9">endm</a>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="preprocessor">#include &quot;asmcommon.inc&quot;</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>
<a name="l00306"></a>00306 ;---------------------------------------------------------------------------
<a name="l00307"></a>00307 ; USB spec says:
<a name="l00308"></a>00308 ; idle = J
<a name="l00309"></a>00309 ; J = (D+ = 0), (D- = 1)
<a name="l00310"></a>00310 ; K = (D+ = 1), (D- = 0)
<a name="l00311"></a>00311 ; Spec allows 7.5 bit times from EOP to SOP <span class="keywordflow">for</span> replies
<a name="l00312"></a>00312 ;---------------------------------------------------------------------------
<a name="l00313"></a>00313 bitstuffN:              ;- [04]
<a name="l00314"></a>00314     eor     x1, x4              ;1 [05]
<a name="l00315"></a>00315     clr     x2          ;1 [06]
<a name="l00316"></a>00316     nop             ;1 [07]
<a name="l00317"></a>00317     rjmp    didStuffN           ;1 [08]
<a name="l00318"></a>00318 ;---------------------------------------------------------------------------    
<a name="l00319"></a>00319 bitstuff6:              ;- [04]
<a name="l00320"></a>00320     eor     x1, x4              ;1 [05]
<a name="l00321"></a>00321     clr     x2          ;1 [06]
<a name="l00322"></a>00322     rjmp    didStuff6           ;1 [07]
<a name="l00323"></a>00323 ;---------------------------------------------------------------------------
<a name="l00324"></a>00324 bitstuff7:              ;- [02]
<a name="l00325"></a>00325     eor     x1, x4              ;1 [03]
<a name="l00326"></a>00326     clr     x2          ;1 [06]
<a name="l00327"></a>00327     nop                 ;1 [05]
<a name="l00328"></a>00328     rjmp    didStuff7           ;1 [06]
<a name="l00329"></a>00329 ;---------------------------------------------------------------------------
<a name="l00330"></a>00330 sendNakAndReti:         ;- [-19]
<a name="l00331"></a>00331     ldi     x3, <a class="code" href="usbdrv_8h.html#a481d1276a9efab04a3ab871b87771aac">USBPID_NAK</a>      ;1 [-18]
<a name="l00332"></a>00332     rjmp    sendX3AndReti       ;1 [-17]
<a name="l00333"></a>00333 ;---------------------------------------------------------------------------
<a name="l00334"></a>00334 sendAckAndReti:         ;- [-17]
<a name="l00335"></a>00335     ldi     cnt, <a class="code" href="usbdrv_8h.html#a7f9994b8bc3a4864604aa8041ed90faf">USBPID_ACK</a>     ;1 [-16]
<a name="l00336"></a>00336 sendCntAndReti:         ;- [-16]
<a name="l00337"></a>00337     mov     x3, cnt             ;1 [-15]
<a name="l00338"></a>00338 sendX3AndReti:          ;- [-15]
<a name="l00339"></a>00339     ldi     YL, 20              ;1 [-14] x3==r20 address is 20
<a name="l00340"></a>00340     ldi     YH, 0               ;1 [-13]
<a name="l00341"></a>00341     ldi     cnt, 2              ;1 [-12]
<a name="l00342"></a>00342 ;   rjmp    usbSendAndReti      fallthrough
<a name="l00343"></a>00343 ;---------------------------------------------------------------------------
<a name="l00344"></a>00344 ;usbSend:
<a name="l00345"></a>00345 ;pointer to data in <span class="charliteral">&#39;Y&#39;</span>
<a name="l00346"></a>00346 ;number of bytes in <span class="stringliteral">&#39;cnt&#39;</span> -- including sync byte [range 2 ... 12]
<a name="l00347"></a>00347 ;uses: x1...x4, btcnt, shift, cnt, Y
<a name="l00348"></a>00348 ;Numbers in brackets are time since first bit of sync pattern is sent
<a name="l00349"></a>00349 ;We need not to match the transfer rate exactly because the spec demands 
<a name="l00350"></a>00350 ;only 1.5% precision anyway.
<a name="l00351"></a>00351 usbSendAndReti:                 ;- [-13] 13 cycles until SOP
<a name="l00352"></a>00352     in      x2, <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>          ;1 [-12]
<a name="l00353"></a>00353     ori     x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>         ;1 [-11]
<a name="l00354"></a>00354     sbi     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>    ;2 [-09-10] prepare idle state; D+ and D- must have been 0 (no pullups)
<a name="l00355"></a>00355     in      x1, USBOUT          ;1 [-08] port mirror <span class="keywordflow">for</span> tx loop
<a name="l00356"></a>00356     out     <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>, x2          ;1 [-07] &lt;- acquire bus
<a name="l00357"></a>00357     ; need not init x2 (bitstuff history) because sync starts with 0 
<a name="l00358"></a>00358     ldi     x4, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>         ;1 [-06]    exor mask
<a name="l00359"></a>00359     ldi     shift, 0x80         ;1 [-05]    sync byte is first byte sent
<a name="l00360"></a>00360     ldi     bitcnt, 6       ;1 [-04] 
<a name="l00361"></a>00361 txBitLoop:              ;- [-04] [06]
<a name="l00362"></a>00362     sbrs    shift, 0            ;1 [-03] [07]
<a name="l00363"></a>00363     eor     x1, x4              ;1 [-02] [08] 
<a name="l00364"></a>00364     ror     shift               ;1 [-01] [09]  
<a name="l00365"></a>00365 didStuffN:              ;-       [09]
<a name="l00366"></a>00366     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1          ;1 [00]  [10] &lt;-- out N
<a name="l00367"></a>00367     ror     x2                  ;1 [01]
<a name="l00368"></a>00368     cpi     x2, 0xfc            ;1 [02]
<a name="l00369"></a>00369     brcc    bitstuffN           ;1 [03]
<a name="l00370"></a>00370     dec     bitcnt              ;1 [04]
<a name="l00371"></a>00371     brne    txBitLoop           ;1 [05]
<a name="l00372"></a>00372     sbrs    shift, 0            ;1 [06]
<a name="l00373"></a>00373     eor     x1, x4              ;1 [07]
<a name="l00374"></a>00374     ror     shift               ;1 [08]
<a name="l00375"></a>00375 didStuff6:          ;- [08]
<a name="l00376"></a>00376     nop             ;1 [09]
<a name="l00377"></a>00377     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1          ;1 [00] [10] &lt;-- out 6
<a name="l00378"></a>00378     ror     x2                  ;1 [01] 
<a name="l00379"></a>00379     cpi     x2, 0xfc            ;1 [02]
<a name="l00380"></a>00380     brcc    bitstuff6           ;1 [03]
<a name="l00381"></a>00381     sbrs    shift, 0            ;1 [04]
<a name="l00382"></a>00382     eor     x1, x4              ;1 [05]
<a name="l00383"></a>00383     ror     shift               ;1 [06]
<a name="l00384"></a>00384     ror     x2                  ;1 [07]
<a name="l00385"></a>00385 didStuff7:          ;- [07]
<a name="l00386"></a>00386     ldi     bitcnt, 6       ;1 [08]
<a name="l00387"></a>00387     cpi     x2, 0xfc            ;1 [09]
<a name="l00388"></a>00388     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1          ;1 [00] [10] &lt;-- out 7
<a name="l00389"></a>00389     brcc    bitstuff7           ;1 [01]
<a name="l00390"></a>00390     ld      shift, y+           ;2 [02+03]
<a name="l00391"></a>00391     dec     cnt                 ;1 [04]
<a name="l00392"></a>00392     brne    txBitLoop       ;1 [05]
<a name="l00393"></a>00393 makeSE0:
<a name="l00394"></a>00394     cbr     x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>         ;1 [06]     prepare SE0 [spec says EOP may be 19 to 23 cycles]
<a name="l00395"></a>00395     lds     x2, <a class="code" href="usbdrv_8c.html#ab9c08d1850db1e4d9feea687bc129425">usbNewDeviceAddr</a>;2 [07+08]
<a name="l00396"></a>00396     lsl     x2                  ;1 [09] we compare with left shifted address
<a name="l00397"></a>00397 ;2006-03-06: moved transfer of <span class="keyword">new</span> address to <a class="code" href="usbdrv_8c.html#a3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a> from C-Code to <span class="keyword">asm</span>:
<a name="l00398"></a>00398 ;<span class="keyword">set</span> address only after data packet was sent, not after handshake
<a name="l00399"></a>00399     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1          ;1 [00] [10] &lt;-- out SE0-- from now 2 bits==20 cycl. until bus idle
<a name="l00400"></a>00400     subi    YL, 20 + 2          ;1 [01] Only assign address on data packets, not ACK/NAK in x3
<a name="l00401"></a>00401     sbci    YH, 0               ;1 [02]
<a name="l00402"></a>00402     breq    skipAddrAssign      ;1 [03]
<a name="l00403"></a>00403     sts     <a class="code" href="usbdrv_8c.html#a3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a>, x2   ;2 [04+05] <span class="keywordflow">if</span> not skipped: SE0 is one cycle longer
<a name="l00404"></a>00404 ;----------------------------------------------------------------------------
<a name="l00405"></a>00405 ;end of usbDeviceAddress transfer
<a name="l00406"></a>00406 skipAddrAssign:             ;- [03/04]
<a name="l00407"></a>00407     ldi     x2, 1&lt;&lt;<a class="code" href="usbdrv_8h.html#abdde2e43a66667f867e3b9ad89a0a31a">USB_INTR_PENDING_BIT</a> ;1 [05] int0 occurred during TX -- clear pending flag
<a name="l00408"></a>00408     USB_STORE_PENDING(x2)           ;1 [06]
<a name="l00409"></a>00409     ori     x1, <a class="code" href="usbdrv_8h.html#ac25f08289ea025246d9682f4ea84ff17">USBIDLE</a>             ;1 [07]
<a name="l00410"></a>00410     in      x2, <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>              ;1 [08]
<a name="l00411"></a>00411     cbr     x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>             ;1 [09] <span class="keyword">set</span> both pins to input
<a name="l00412"></a>00412     mov     x3, x1                  ;1 [10]
<a name="l00413"></a>00413     cbr     x3, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>             ;1 [11] configure no pullup on both pins
<a name="l00414"></a>00414     ldi     x4, 3                   ;1 [12]
<a name="l00415"></a>00415 se0Delay:               ;- [12] [15] 
<a name="l00416"></a>00416     dec     x4                      ;1 [13] [16] 
<a name="l00417"></a>00417     brne    se0Delay                ;1 [14] [17] 
<a name="l00418"></a>00418     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>                ;2      [18+19]
<a name="l00419"></a>00419     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1              ;1      [20] &lt;--out J (idle) -- end of SE0 (EOP sig.)
<a name="l00420"></a>00420     out     USBDDR, x2              ;1      [21] &lt;--release bus now
<a name="l00421"></a>00421     out     USBOUT, x3              ;1      [22] &lt;--ensure no pull-up resistors are active
<a name="l00422"></a>00422     rjmp    doReturn            ;1  [23]
<a name="l00423"></a>00423 ;---------------------------------------------------------------------------
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Feb 16 2012 17:16:54 for softusbduino by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
