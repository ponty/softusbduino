<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>softusbduino: SoftUsb/usbdrvasm16.inc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">softusbduino</div>
  </td>
  <td>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">SoftUsb/usbdrvasm16.inc</div>  </div>
</div>
<div class="contents">
<a href="usbdrvasm16_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Name: usbdrvasm16.inc</span>
<a name="l00002"></a>00002 <span class="comment"> * Project: V-USB, virtual USB port for Atmel&#39;s(r) AVR(r) microcontrollers</span>
<a name="l00003"></a>00003 <span class="comment"> * Author: Christian Starkjohann</span>
<a name="l00004"></a>00004 <span class="comment"> * Creation Date: 2007-06-15</span>
<a name="l00005"></a>00005 <span class="comment"> * Tabsize: 4</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright: (c) 2007 by OBJECTIVE DEVELOPMENT Software GmbH</span>
<a name="l00007"></a>00007 <span class="comment"> * License: GNU GPL v2 (see License.txt), GNU GPL v3 or proprietary (CommercialLicense.txt)</span>
<a name="l00008"></a>00008 <span class="comment"> * Revision: $Id: usbdrvasm16.inc 760 2009-08-09 18:59:43Z cs $</span>
<a name="l00009"></a>00009 <span class="comment"> */</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">/* Do not link this file! Link usbdrvasm.S instead, which includes the</span>
<a name="l00012"></a>00012 <span class="comment"> * appropriate implementation!</span>
<a name="l00013"></a>00013 <span class="comment"> */</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">/*</span>
<a name="l00016"></a>00016 <span class="comment">General Description:</span>
<a name="l00017"></a>00017 <span class="comment">This file is the 16 MHz version of the asssembler part of the USB driver. It</span>
<a name="l00018"></a>00018 <span class="comment">requires a 16 MHz crystal (not a ceramic resonator and not a calibrated RC</span>
<a name="l00019"></a>00019 <span class="comment">oscillator).</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">See usbdrv.h for a description of the entire driver.</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">Since almost all of this code is timing critical, don&#39;t change unless you</span>
<a name="l00024"></a>00024 <span class="comment">really know what you are doing! Many parts require not only a maximum number</span>
<a name="l00025"></a>00025 <span class="comment">of CPU cycles, but even an exact number of cycles!</span>
<a name="l00026"></a>00026 <span class="comment">*/</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 ;max stack usage: [ret(2), YL, SREG, YH, bitcnt, shift, x1, x2, x3, x4, cnt] = 12 bytes
<a name="l00029"></a>00029 ;nominal frequency: 16 MHz -&gt; 10.6666666 cycles per bit, 85.333333333 cycles per byte
<a name="l00030"></a>00030 ; Numbers in brackets are clocks counted from center of last sync bit
<a name="l00031"></a>00031 ; when instruction starts
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 USB_INTR_VECTOR:
<a name="l00034"></a>00034 ;order of registers pushed: YL, SREG YH, [sofError], bitcnt, shift, x1, x2, x3, x4, cnt
<a name="l00035"></a>00035     push    YL                  ;[-25] push only what is necessary to sync with edge ASAP
<a name="l00036"></a>00036     in      YL, SREG            ;[-23]
<a name="l00037"></a>00037     push    YL                  ;[-22]
<a name="l00038"></a>00038     push    YH                  ;[-20]
<a name="l00039"></a>00039 ;----------------------------------------------------------------------------
<a name="l00040"></a>00040 ; Synchronize with sync pattern:
<a name="l00041"></a>00041 ;----------------------------------------------------------------------------
<a name="l00042"></a>00042 ;sync byte (D-) pattern LSb to MSb: 01010100 [1 = idle = J, 0 = K]
<a name="l00043"></a>00043 ;sync up with J to K edge during sync pattern -- use fastest possible loops
<a name="l00044"></a>00044 ;The first part waits at most 1 bit <span class="keywordtype">long</span> since we must be in sync pattern.
<a name="l00045"></a>00045 ;YL is guarenteed to be &lt; 0x80 because I flag is clear. When we jump to
<a name="l00046"></a>00046 ;waitForJ, ensure that this prerequisite is met.
<a name="l00047"></a>00047 waitForJ:
<a name="l00048"></a>00048     inc     YL
<a name="l00049"></a>00049     sbis    <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>
<a name="l00050"></a>00050     brne    waitForJ        ; just make sure we have ANY timeout
<a name="l00051"></a>00051 waitForK:
<a name="l00052"></a>00052 ;The following code results in a sampling window of &lt; 1/4 bit which meets the spec.
<a name="l00053"></a>00053     sbis    USBIN, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>     ;[-15]
<a name="l00054"></a>00054     rjmp    foundK              ;[-14]
<a name="l00055"></a>00055     sbis    USBIN, USBMINUS
<a name="l00056"></a>00056     rjmp    foundK
<a name="l00057"></a>00057     sbis    USBIN, USBMINUS
<a name="l00058"></a>00058     rjmp    foundK
<a name="l00059"></a>00059     sbis    USBIN, USBMINUS
<a name="l00060"></a>00060     rjmp    foundK
<a name="l00061"></a>00061     sbis    USBIN, USBMINUS
<a name="l00062"></a>00062     rjmp    foundK
<a name="l00063"></a>00063     sbis    USBIN, USBMINUS
<a name="l00064"></a>00064     rjmp    foundK
<a name="l00065"></a>00065 <span class="preprocessor">#if USB_COUNT_SOF</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>    lds     YL, usbSofCount
<a name="l00067"></a>00067     inc     YL
<a name="l00068"></a>00068     sts     usbSofCount, YL
<a name="l00069"></a>00069 <span class="preprocessor">#endif  </span><span class="comment">/* USB_COUNT_SOF */</span>
<a name="l00070"></a>00070 <span class="preprocessor">#ifdef USB_SOF_HOOK</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>    USB_SOF_HOOK
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>    rjmp    sofError
<a name="l00074"></a>00074 foundK:                         ;[-12]
<a name="l00075"></a>00075 ;{3, 5} after falling D- edge, average delay: 4 cycles [we want 5 <span class="keywordflow">for</span> center sampling]
<a name="l00076"></a>00076 ;we have 1 bit time <span class="keywordflow">for</span> setup purposes, then sample again. Numbers in brackets
<a name="l00077"></a>00077 ;are cycles from center of first sync (<span class="keywordtype">double</span> K) bit after the instruction
<a name="l00078"></a>00078     push    bitcnt              ;[-12]
<a name="l00079"></a>00079 ;   [---]                       ;[-11]
<a name="l00080"></a>00080     lds     YL, <a class="code" href="usbdrv_8c.html#a6b0f7b83997deee705eb56462e3f1fce">usbInputBufOffset</a>;[-10]
<a name="l00081"></a>00081 ;   [---]                       ;[-9]
<a name="l00082"></a>00082     clr     YH                  ;[-8]
<a name="l00083"></a>00083     subi    YL, lo8(-(<a class="code" href="usbdrv_8c.html#a50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>));[-7] [rx loop init]
<a name="l00084"></a>00084     sbci    YH, hi8(-(<a class="code" href="usbdrv_8c.html#a50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>));[-6] [rx loop init]
<a name="l00085"></a>00085     push    shift               ;[-5]
<a name="l00086"></a>00086 ;   [---]                       ;[-4]
<a name="l00087"></a>00087     ldi     bitcnt, 0x55        ;[-3] [rx loop init]
<a name="l00088"></a>00088     sbis    <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>     ;[-2] we want two bits K (sample 2 cycles too early)
<a name="l00089"></a>00089     rjmp    haveTwoBitsK        ;[-1]
<a name="l00090"></a>00090     pop     shift               ;[0] undo the push from before
<a name="l00091"></a>00091     pop     bitcnt              ;[2] undo the push from before
<a name="l00092"></a>00092     rjmp    waitForK            ;[4] <span class="keyword">this</span> was not the end of sync, retry
<a name="l00093"></a>00093 ; The entire loop from waitForK until rjmp waitForK above must not exceed two
<a name="l00094"></a>00094 ; bit times (= 21 cycles).
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 ;----------------------------------------------------------------------------
<a name="l00097"></a>00097 ; push more registers and initialize values <span class="keywordflow">while</span> we sample the first bits:
<a name="l00098"></a>00098 ;----------------------------------------------------------------------------
<a name="l00099"></a>00099 haveTwoBitsK:
<a name="l00100"></a>00100     push    x1              ;[1]
<a name="l00101"></a>00101     push    x2              ;[3]
<a name="l00102"></a>00102     push    x3              ;[5]
<a name="l00103"></a>00103     ldi     shift, 0        ;[7]
<a name="l00104"></a>00104     ldi     x3, 1&lt;&lt;4        ;[8] [rx loop init] first sample is inverse bit, compensate that
<a name="l00105"></a>00105     push    x4              ;[9] == leap
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     in      x1, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>       ;[11] &lt;-- sample bit 0
<a name="l00108"></a>00108     andi    x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;[12]
<a name="l00109"></a>00109     bst     x1, <a class="code" href="usbdrv_8h.html#ad84a1c137f273772bcba266e0a671d33">USBMINUS</a>    ;[13]
<a name="l00110"></a>00110     bld     shift, 7        ;[14]
<a name="l00111"></a>00111     push    cnt             ;[15]
<a name="l00112"></a>00112     ldi     leap, 0         ;[17] [rx loop init]
<a name="l00113"></a>00113     ldi     cnt, <a class="code" href="usbdrv_8h.html#a1c541dbab181ea7bd3da61b892430988">USB_BUFSIZE</a>;[18] [rx loop init]
<a name="l00114"></a>00114     rjmp    rxbit1          ;[19] arrives at [21]
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 ;----------------------------------------------------------------------------
<a name="l00117"></a>00117 ; Receiver loop (numbers in brackets are cycles within byte after instr)
<a name="l00118"></a>00118 ;----------------------------------------------------------------------------
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 ; duration of unstuffing code should be 10.66666667 cycles. We adjust <span class="stringliteral">&quot;leap&quot;</span>
<a name="l00121"></a>00121 ; accordingly to approximate <span class="keyword">this</span> value in the <span class="keywordtype">long</span> run.
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 unstuff6:
<a name="l00124"></a>00124     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[03]
<a name="l00125"></a>00125     ori     x3, 1&lt;&lt;6    ;[04] will not be shifted any more
<a name="l00126"></a>00126     andi    shift, ~0x80;[05]
<a name="l00127"></a>00127     mov     x1, x2      ;[06] sampled bit 7 is actually re-sampled bit 6
<a name="l00128"></a>00128     subi    leap, -1    ;[07] total duration = 11 bits -&gt; subtract 1/3
<a name="l00129"></a>00129     rjmp    didUnstuff6 ;[08]
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 unstuff7:
<a name="l00132"></a>00132     ori     x3, 1&lt;&lt;7    ;[09] will not be shifted any more
<a name="l00133"></a>00133     in      x2, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [10]  re-sample bit 7
<a name="l00134"></a>00134     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[01]
<a name="l00135"></a>00135     andi    shift, ~0x80;[02]
<a name="l00136"></a>00136     subi    leap, 2     ;[03] total duration = 10 bits -&gt; add 1/3
<a name="l00137"></a>00137     rjmp    didUnstuff7 ;[04]
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 unstuffEven:
<a name="l00140"></a>00140     ori     x3, 1&lt;&lt;6    ;[09] will be shifted right 6 times <span class="keywordflow">for</span> bit 0
<a name="l00141"></a>00141     in      x1, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [10]
<a name="l00142"></a>00142     andi    shift, ~0x80;[01]
<a name="l00143"></a>00143     andi    x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[02]
<a name="l00144"></a>00144     breq    se0         ;[03]
<a name="l00145"></a>00145     subi    leap, -1    ;[04] total duration = 11 bits -&gt; subtract 1/3
<a name="l00146"></a>00146     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>                ;[05]
<a name="l00147"></a>00147     rjmp    didUnstuffE ;[06]
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 unstuffOdd:
<a name="l00150"></a>00150     ori     x3, 1&lt;&lt;5    ;[09] will be shifted right 4 times <span class="keywordflow">for</span> bit 1
<a name="l00151"></a>00151     in      x2, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [10]
<a name="l00152"></a>00152     andi    shift, ~0x80;[01]
<a name="l00153"></a>00153     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[02]
<a name="l00154"></a>00154     breq    se0         ;[03]
<a name="l00155"></a>00155     subi    leap, -1    ;[04] total duration = 11 bits -&gt; subtract 1/3
<a name="l00156"></a>00156     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>                ;[05]
<a name="l00157"></a>00157     rjmp    didUnstuffO ;[06]
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 rxByteLoop:
<a name="l00160"></a>00160     andi    x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[03]
<a name="l00161"></a>00161     eor     x2, x1      ;[04]
<a name="l00162"></a>00162     subi    leap, 1     ;[05]
<a name="l00163"></a>00163     brpl    skipLeap    ;[06]
<a name="l00164"></a>00164     subi    leap, -3    ;1 one leap cycle every 3rd byte -&gt; 85 + 1/3 cycles per byte
<a name="l00165"></a>00165     nop                 ;1
<a name="l00166"></a>00166 skipLeap:
<a name="l00167"></a>00167     subi    x2, 1       ;[08]
<a name="l00168"></a>00168     ror     shift       ;[09]
<a name="l00169"></a>00169 didUnstuff6:
<a name="l00170"></a>00170     cpi     shift, 0xfc ;[10]
<a name="l00171"></a>00171     in      x2, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [11] &lt;-- sample bit 7
<a name="l00172"></a>00172     brcc    unstuff6    ;[01]
<a name="l00173"></a>00173     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[02]
<a name="l00174"></a>00174     eor     x1, x2      ;[03]
<a name="l00175"></a>00175     subi    x1, 1       ;[04]
<a name="l00176"></a>00176     ror     shift       ;[05]
<a name="l00177"></a>00177 didUnstuff7:
<a name="l00178"></a>00178     cpi     shift, 0xfc ;[06]
<a name="l00179"></a>00179     brcc    unstuff7    ;[07]
<a name="l00180"></a>00180     eor     x3, shift   ;[08] reconstruct: x3 is 1 at bit locations we changed, 0 at others
<a name="l00181"></a>00181     st      y+, x3      ;[09] store data
<a name="l00182"></a>00182 rxBitLoop:
<a name="l00183"></a>00183     in      x1, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [11] &lt;-- sample bit 0/2/4
<a name="l00184"></a>00184     andi    x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[01]
<a name="l00185"></a>00185     eor     x2, x1      ;[02]
<a name="l00186"></a>00186     andi    x3, 0x3f    ;[03] topmost two bits reserved <span class="keywordflow">for</span> 6 and 7
<a name="l00187"></a>00187     subi    x2, 1       ;[04]
<a name="l00188"></a>00188     ror     shift       ;[05]
<a name="l00189"></a>00189     cpi     shift, 0xfc ;[06]
<a name="l00190"></a>00190     brcc    unstuffEven ;[07]
<a name="l00191"></a>00191 didUnstuffE:
<a name="l00192"></a>00192     lsr     x3          ;[08]
<a name="l00193"></a>00193     lsr     x3          ;[09]
<a name="l00194"></a>00194 rxbit1:
<a name="l00195"></a>00195     in      x2, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [10] &lt;-- sample bit 1/3/5
<a name="l00196"></a>00196     andi    x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a> ;[01]
<a name="l00197"></a>00197     breq    se0         ;[02]
<a name="l00198"></a>00198     eor     x1, x2      ;[03]
<a name="l00199"></a>00199     subi    x1, 1       ;[04]
<a name="l00200"></a>00200     ror     shift       ;[05]
<a name="l00201"></a>00201     cpi     shift, 0xfc ;[06]
<a name="l00202"></a>00202     brcc    unstuffOdd  ;[07]
<a name="l00203"></a>00203 didUnstuffO:
<a name="l00204"></a>00204     subi    bitcnt, 0xab;[08] == addi 0x55, 0x55 = 0x100/3
<a name="l00205"></a>00205     brcs    rxBitLoop   ;[09]
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     subi    cnt, 1      ;[10]
<a name="l00208"></a>00208     in      x1, <a class="code" href="usbdrv_8h.html#a85296740a603c928460d39ef9be869a4">USBIN</a>   ;[00] [11] &lt;-- sample bit 6
<a name="l00209"></a>00209     brcc    rxByteLoop  ;[01]
<a name="l00210"></a>00210     rjmp    overflow
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <a class="code" href="usbportability_8h.html#a27188a3f4bdad4750865cc4b0d001559">macro</a> POP_STANDARD ; 14 cycles
<a name="l00213"></a>00213     pop     cnt
<a name="l00214"></a>00214     pop     x4
<a name="l00215"></a>00215     pop     x3
<a name="l00216"></a>00216     pop     x2
<a name="l00217"></a>00217     pop     x1
<a name="l00218"></a>00218     pop     shift
<a name="l00219"></a>00219     pop     bitcnt
<a name="l00220"></a>00220     <a class="code" href="usbportability_8h.html#a42431a55be9ecfc03292cc1601e5c4d9">endm</a>
<a name="l00221"></a>00221 <a class="code" href="usbportability_8h.html#a27188a3f4bdad4750865cc4b0d001559">macro</a> POP_RETI     ; 7 cycles
<a name="l00222"></a>00222     pop     YH
<a name="l00223"></a>00223     pop     YL
<a name="l00224"></a>00224     out     SREG, YL
<a name="l00225"></a>00225     pop     YL
<a name="l00226"></a>00226     <a class="code" href="usbportability_8h.html#a42431a55be9ecfc03292cc1601e5c4d9">endm</a>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="preprocessor">#include &quot;<a class="code" href="asmcommon_8inc.html">asmcommon.inc</a>&quot;</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 ; USB spec says:
<a name="l00231"></a>00231 ; idle = J
<a name="l00232"></a>00232 ; J = (D+ = 0), (D- = 1)
<a name="l00233"></a>00233 ; K = (D+ = 1), (D- = 0)
<a name="l00234"></a>00234 ; Spec allows 7.5 bit times from EOP to SOP <span class="keywordflow">for</span> replies
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 bitstuffN:
<a name="l00237"></a>00237     eor     x1, x4          ;[5]
<a name="l00238"></a>00238     ldi     x2, 0           ;[6]
<a name="l00239"></a>00239     <a class="code" href="usbportability_8h.html#a62df5117c12fbb897e5d6956620d794b">nop2</a>                    ;[7]
<a name="l00240"></a>00240     nop                     ;[9]
<a name="l00241"></a>00241     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[10] &lt;-- out
<a name="l00242"></a>00242     rjmp    didStuffN       ;[0]
<a name="l00243"></a>00243     
<a name="l00244"></a>00244 bitstuff6:
<a name="l00245"></a>00245     eor     x1, x4          ;[5]
<a name="l00246"></a>00246     ldi     x2, 0           ;[6] Carry is zero due to brcc
<a name="l00247"></a>00247     rol     shift           ;[7] compensate <span class="keywordflow">for</span> ror shift at branch destination
<a name="l00248"></a>00248     rjmp    didStuff6       ;[8]
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 bitstuff7:
<a name="l00251"></a>00251     ldi     x2, 0           ;[2] Carry is zero due to brcc
<a name="l00252"></a>00252     rjmp    didStuff7       ;[3]
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 sendNakAndReti:
<a name="l00256"></a>00256     ldi     x3, <a class="code" href="usbdrv_8h.html#a481d1276a9efab04a3ab871b87771aac">USBPID_NAK</a>  ;[-18]
<a name="l00257"></a>00257     rjmp    sendX3AndReti   ;[-17]
<a name="l00258"></a>00258 sendAckAndReti:
<a name="l00259"></a>00259     ldi     cnt, <a class="code" href="usbdrv_8h.html#a7f9994b8bc3a4864604aa8041ed90faf">USBPID_ACK</a> ;[-17]
<a name="l00260"></a>00260 sendCntAndReti:
<a name="l00261"></a>00261     mov     x3, cnt         ;[-16]
<a name="l00262"></a>00262 sendX3AndReti:
<a name="l00263"></a>00263     ldi     YL, 20          ;[-15] x3==r20 address is 20
<a name="l00264"></a>00264     ldi     YH, 0           ;[-14]
<a name="l00265"></a>00265     ldi     cnt, 2          ;[-13]
<a name="l00266"></a>00266 ;   rjmp    usbSendAndReti      fallthrough
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 ;usbSend:
<a name="l00269"></a>00269 ;pointer to data in <span class="charliteral">&#39;Y&#39;</span>
<a name="l00270"></a>00270 ;number of bytes in <span class="stringliteral">&#39;cnt&#39;</span> -- including sync byte [range 2 ... 12]
<a name="l00271"></a>00271 ;uses: x1...x4, btcnt, shift, cnt, Y
<a name="l00272"></a>00272 ;Numbers in brackets are time since first bit of sync pattern is sent
<a name="l00273"></a>00273 ;We don<span class="stringliteral">&#39;t match the transfer rate exactly (don&#39;</span>t insert leap cycles every third
<a name="l00274"></a>00274 ;byte) because the spec demands only 1.5% precision anyway.
<a name="l00275"></a>00275 usbSendAndReti:             ; 12 cycles until SOP
<a name="l00276"></a>00276     in      x2, <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>      ;[-12]
<a name="l00277"></a>00277     ori     x2, USBMASK     ;[-11]
<a name="l00278"></a>00278     sbi     USBOUT, USBMINUS;[-10] prepare idle state; D+ and D- must have been 0 (no pullups)
<a name="l00279"></a>00279     in      x1, <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>      ;[-8] port mirror <span class="keywordflow">for</span> tx loop
<a name="l00280"></a>00280     out     <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>, x2      ;[-7] &lt;- acquire bus
<a name="l00281"></a>00281 ; need not init x2 (bitstuff history) because sync starts with 0
<a name="l00282"></a>00282     ldi     x4, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;[-6] exor mask
<a name="l00283"></a>00283     ldi     shift, 0x80     ;[-5] sync byte is first byte sent
<a name="l00284"></a>00284 txByteLoop:
<a name="l00285"></a>00285     ldi     bitcnt, 0x35    ;[-4] [6] binary 0011 0101
<a name="l00286"></a>00286 txBitLoop:
<a name="l00287"></a>00287     sbrs    shift, 0        ;[-3] [7]
<a name="l00288"></a>00288     eor     x1, x4          ;[-2] [8]
<a name="l00289"></a>00289     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[-1] [9] &lt;-- out N
<a name="l00290"></a>00290     ror     shift           ;[0] [10]
<a name="l00291"></a>00291     ror     x2              ;[1]
<a name="l00292"></a>00292 didStuffN:
<a name="l00293"></a>00293     cpi     x2, 0xfc        ;[2]
<a name="l00294"></a>00294     brcc    bitstuffN       ;[3]
<a name="l00295"></a>00295     lsr     bitcnt          ;[4]
<a name="l00296"></a>00296     brcc    txBitLoop       ;[5]
<a name="l00297"></a>00297     brne    txBitLoop       ;[6]
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     sbrs    shift, 0        ;[7]
<a name="l00300"></a>00300     eor     x1, x4          ;[8]
<a name="l00301"></a>00301 didStuff6:
<a name="l00302"></a>00302     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[-1] [9] &lt;-- out 6
<a name="l00303"></a>00303     ror     shift           ;[0] [10]
<a name="l00304"></a>00304     ror     x2              ;[1]
<a name="l00305"></a>00305     cpi     x2, 0xfc        ;[2]
<a name="l00306"></a>00306     brcc    bitstuff6       ;[3]
<a name="l00307"></a>00307     ror     shift           ;[4]
<a name="l00308"></a>00308 didStuff7:
<a name="l00309"></a>00309     ror     x2              ;[5]
<a name="l00310"></a>00310     sbrs    x2, 7           ;[6]
<a name="l00311"></a>00311     eor     x1, x4          ;[7]
<a name="l00312"></a>00312     nop                     ;[8]
<a name="l00313"></a>00313     cpi     x2, 0xfc        ;[9]
<a name="l00314"></a>00314     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[-1][10] &lt;-- out 7
<a name="l00315"></a>00315     brcc    bitstuff7       ;[0] [11]
<a name="l00316"></a>00316     ld      shift, y+       ;[1]
<a name="l00317"></a>00317     dec     cnt             ;[3]
<a name="l00318"></a>00318     brne    txByteLoop      ;[4]
<a name="l00319"></a>00319 ;make SE0:
<a name="l00320"></a>00320     cbr     x1, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;[5] prepare SE0 [spec says EOP may be 21 to 25 cycles]
<a name="l00321"></a>00321     lds     x2, <a class="code" href="usbdrv_8c.html#ab9c08d1850db1e4d9feea687bc129425">usbNewDeviceAddr</a>;[6]
<a name="l00322"></a>00322     lsl     x2              ;[8] we compare with left shifted address
<a name="l00323"></a>00323     subi    YL, 20 + 2      ;[9] Only assign address on data packets, not ACK/NAK in x3
<a name="l00324"></a>00324     sbci    YH, 0           ;[10]
<a name="l00325"></a>00325     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[11] &lt;-- out SE0 -- from now 2 bits = 22 cycles until bus idle
<a name="l00326"></a>00326 ;2006-03-06: moved transfer of <span class="keyword">new</span> address to <a class="code" href="usbdrv_8c.html#a3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a> from C-Code to <span class="keyword">asm</span>:
<a name="l00327"></a>00327 ;<span class="keyword">set</span> address only after data packet was sent, not after handshake
<a name="l00328"></a>00328     breq    skipAddrAssign  ;[0]
<a name="l00329"></a>00329     sts     <a class="code" href="usbdrv_8c.html#a3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a>, x2; <span class="keywordflow">if</span> not skipped: SE0 is one cycle longer
<a name="l00330"></a>00330 skipAddrAssign:
<a name="l00331"></a>00331 ;end of usbDeviceAddress transfer
<a name="l00332"></a>00332     ldi     x2, 1&lt;&lt;<a class="code" href="usbdrv_8h.html#abdde2e43a66667f867e3b9ad89a0a31a">USB_INTR_PENDING_BIT</a>;[2] int0 occurred during TX -- clear pending flag
<a name="l00333"></a>00333     USB_STORE_PENDING(x2)   ;[3]
<a name="l00334"></a>00334     ori     x1, <a class="code" href="usbdrv_8h.html#ac25f08289ea025246d9682f4ea84ff17">USBIDLE</a>     ;[4]
<a name="l00335"></a>00335     in      x2, <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>      ;[5]
<a name="l00336"></a>00336     cbr     x2, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;[6] <span class="keyword">set</span> both pins to input
<a name="l00337"></a>00337     mov     x3, x1          ;[7]
<a name="l00338"></a>00338     cbr     x3, <a class="code" href="usbdrv_8h.html#a0140266b6db5af6ba9167f04a91ca076">USBMASK</a>     ;[8] configure no pullup on both pins
<a name="l00339"></a>00339     ldi     x4, 4           ;[9]
<a name="l00340"></a>00340 se0Delay:
<a name="l00341"></a>00341     dec     x4              ;[10] [13] [16] [19]
<a name="l00342"></a>00342     brne    se0Delay        ;[11] [14] [17] [20]
<a name="l00343"></a>00343     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x1      ;[21] &lt;-- out J (idle) -- end of SE0 (EOP signal)
<a name="l00344"></a>00344     out     <a class="code" href="usbdrv_8h.html#a3ffc8a49ee40206cfce717574a1ccfea">USBDDR</a>, x2      ;[22] &lt;-- release bus now
<a name="l00345"></a>00345     out     <a class="code" href="usbdrv_8h.html#ad95fd90d841998e6b54cb99c49ee1247">USBOUT</a>, x3      ;[23] &lt;-- ensure no pull-up resistors are active
<a name="l00346"></a>00346     rjmp    doReturn
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Feb 16 2012 17:16:54 for softusbduino by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
